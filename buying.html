<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Available Crops - AgriConnect</title>
  <link rel="stylesheet" href="css/style.css">
  <style>
    /* Crop Card Styles */
    .feature-card img {
      width: 40px;
      height: 40px;
      margin-right: 10px;
      vertical-align: middle;
    }

    .price-cheap { color: #1b4332; font-weight: bold; }      /* Green */
    .price-moderate { color: #ffb703; font-weight: bold; }   /* Orange */
    .price-expensive { color: #d00000; font-weight: bold; }  /* Red */

    .feature-card input {
      width: 80px;
      margin-right: 10px;
      padding: 6px;
    }

    .feature-card button {
      padding: 6px 12px;
      background-color: #2d6a4f;
      color: #fff;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: background 0.3s;
    }

    .feature-card button:hover {
      background-color: #1b4332;
    }
  </style>
</head>
<body>
<header class="navbar">
  <div class="logo">
    <img src="assets/logo.png" alt="AgriConnect Logo">
    <h1>AgriConnect</h1>
  </div>
  <nav>
    <a href="marketplace.html">Marketplace</a>
    <button id="logoutBtn" class="btn-logout">Logout</button>
  </nav>
</header>

<div class="dashboard-container">
  <h2>Available Crops to Buy</h2>
  <div id="availableCrops" class="feature-grid"></div>
</div>

<footer>
  <p>© 2025 AgriConnect. All Rights Reserved.</p>
</footer>

<script src="js/auth.js"></script>
<script>
document.addEventListener("DOMContentLoaded", () => {
  const user = JSON.parse(localStorage.getItem("currentUser"));
  if(!user){ alert("⚠️ Please login first!"); window.location.href="login.html"; }

  document.getElementById("logoutBtn").addEventListener("click", () => {
    localStorage.removeItem("currentUser");
    window.location.href="index.html";
  });

  const availableCropsDiv = document.getElementById("availableCrops");

  function loadAvailableCrops(){
    const crops = JSON.parse(localStorage.getItem("crops")) || [];
    availableCropsDiv.innerHTML = "";

    crops.filter(c => c.owner !== user.email).forEach((crop, idx)=>{
      let priceClass = "price-moderate";
      if(crop.price < 50) priceClass = "price-cheap";
      else if(crop.price > 150) priceClass = "price-expensive";

      const card = document.createElement("div");
      card.classList.add("feature-card");
      card.innerHTML = `
        <h3>
          <img src="assets/images/${crop.icon || 'default.png'}" alt="${crop.name} Icon">
          ${crop.name}
        </h3>
        <p>Quantity: ${crop.quantity} kg</p>
        <p>Location: ${crop.location}</p>
        <p class="${priceClass}">Price: ₹${crop.price}/kg</p>
        <input type="number" min="1" max="${crop.quantity}" placeholder="Qty" id="buyQty${idx}">
        <button onclick="buyCrop(${idx})">Buy</button>
      `;
      availableCropsDiv.appendChild(card);
    });
  }

  window.buyCrop = function(idx){
    const crops = JSON.parse(localStorage.getItem("crops")) || [];
    const crop = crops.filter(c=>c.owner!==user.email)[idx];
    const qty = Number(document.getElementById(`buyQty${idx}`).value);
    if(!qty || qty < 1 || qty > crop.quantity){
      alert("⚠️ Enter valid quantity!");
      return;
    }

    // Update quantity
    crop.quantity -= qty;
    const allCrops = JSON.parse(localStorage.getItem("crops")) || [];
    const indexAll = allCrops.findIndex(c=>c.name===crop.name && c.owner===crop.owner);
    allCrops[indexAll] = crop;
    localStorage.setItem("crops", JSON.stringify(allCrops));

    // Record transaction
    const transactions = JSON.parse(localStorage.getItem("transactions")) || [];
    transactions.push({
      crop: crop.name,
      quantity: qty,
      price: crop.price,
      buyer: user.email,
      seller: crop.owner,
      type: "bought",
      date: new Date().toLocaleString()
    });
    localStorage.setItem("transactions", JSON.stringify(transactions));

    alert(`✅ Purchased ${qty}kg of ${crop.name}`);
    loadAvailableCrops();
  }

  loadAvailableCrops();
});
</script>
</body>
</html>
